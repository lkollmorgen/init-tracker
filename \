from flask import Flask, render_template, request, redirect, url_for, send_file, session, jsonify
import json
import os
import threading
import csv
import io
from datetime import datetime
import random, string

DATA_FILE = 'initiative_data.json'
data_lock = threading.Lock() #prevent simulitaneous read/write

app = Flask(__name__)

#temp data store
#initiative_list = []
#notes = []
#current_turn = 0
#round_count = 1

# session tracking
app.secret_key = 'supersecretkey'

sessions = {}
sessions_lock = threading.Lock()

def generate_code(length=4):
    return ''.join(random.choices(string.ascii_uppercase + string.digits, k=length))

@app.route('/')
def landing():
    return render_template('landing.html')

@app.route('/create_session', methods=['POST'])
def create_session():
    with sessions_lock:
        code = generate_code()
        #while code in sessions:
        #code = generate_code()
        sessions[code] = {
                'initiative_list': [],
                'notes': [],
                'current_turn': 0,
                'round_count': 1
                }
    session['join_code'] = code
    print(f'session created! Code: {code}')
    return redirect(url_for('admin_view', code=code))

@app.route('/join_session', methods=['POST'])
def join_session():
    code = request.form['code'].strip().upper()
    if code in sessions:
        return redirect(url_for('player_view', code=code))
    else:
        return render_template('landing.html', error='Invalid code')

def init_data_file():
	"""create a fully validated data file if it doesn't exist yet"""
	#if not os.path.exists(DATA_FILE):
	print("initializing data file with defaults")
	default_data = {
		'initiative_list': [],
		'current_turn': 0,
		'round_count': 1,
		'notes': []
	}
		
	with open(DATA_FILE, 'w') as f:
		json.dump(default_data, f, indent=2)

@app.route('/')
def home():
    return redirect(url_for('landing'))

###### json data helper functions
def save_data():
    if not DATA_FILE:
        print('initializing json')
        json.dump(sessions, f, indent=2)
    temp_file = DATA_FILE + '.tmp'
    print(temp_file)
    with data_lock:
        try:
            with open(temp_file, 'w') as f:
                print('trying to make a temp file for data init')
                json.dump(sessions, f, indent=2)
            os.replace(temp_file, DATA_FILE)
        except Exception as e:
            print("Error saving data:", e)

def import_csv(code, filename):
    """load combatants from .csv if you please"""
    game = session.get(code)
    if not game:
        return "session not found ):", 404
    try:
        with open(filename, newline='') as csvfile:
            reader = csv.DictReader(csvfile)
            for row in reader:
                game['initiative_list'].append({
                    'name': row['name'],
                    'initiative': int(row['initiative']),
                    'status': row.get('status', 'alive') #defult to alive
                })
            game['initiative_list'].sort(key=lambda x: x['initiative'], reverse=True)
            print("loaded .csv file")
    except FileNotFoundError:
        print(f"no csv file found: {filename}")
    except Exception as e:
        print(f"error importing csv: {e}")

@app.route('/<code>/export')
def export_initiative(code):
    game = sessions.get(code)
    if not game:
        return "session not found ):", 404
    # get date/time
    current_datetime = datetime.now()
    current_date = str(current_datetime.date())

    # create an in-memory CSV file
    output = io.StringIO()
    writer = csv.writer(output)
    writer.writerow(['Name','Initiative', 'Status'])
    for combatant in game['initiative_list']:
        writer.writerow([combatant['name'], combatant['initiative'], combatant['status']])

    writer.writerow(notes)
    # move cursor back 2 the start
    output.seek(0)

    return send_file(
            io.BytesIO(output.getvalue().encode()),
            mimetype='tet/csv',
            as_attachment=True,
            download_name='initiative_'+current_date+'.csv'
    )

def load_data():
    global sessions
    with data_lock:
        if os.path.exists(DATA_FILE):
            try:
                with open(DATA_FILE, 'r') as f:
                        sessions = json.load(f)
                return
            except json.JSONDecodeError as e:
                print("Warning: JSON decode error:", e)
            except Exception as e:
                print("Error loading data:", e)
        
        if os.path.exists('initiative.csv'):
            print('found initiative.csv, importing peeps')
            import_csv('initiative.csv')
            save_data()
        else:
            print('no data file found, initializing empty state')
            sessions = {}
            save_data()

#init_data_file()

@app.route('/player_data/<code>')
def player_data(code):
    game = sessions.get(code)
    if not game:
        return jsonify({'error': 'Invalid code'}), 404
    return jsonify({
            'initiative_list': game['initiative_list'],
            'current_turn': game['current_turn'],
            'round_count': game['round_count'],
            'notes': game['notes']
    })

@app.route('/player/<code>')
def player_view(code):
    game = sessions.get(code)
    if not game:
        return "Session not found ):", 404
    return render_template('player.html',
                            initiative_list = game['initiative_list'],
                            current_turn = game['current_turn'],
                            round_count= game['round_count'],
                            notes=game['notes'],
                            code=code)

@app.route('/admin/<code>')
def admin_view(code):
    game = sessions.get(code)
    if not game:
        return 'Session not found ):', 404
    load_data()
    #return render_template('admin.html', code=code, **game)
    return render_template('admin.html', 
                            initiative_list=game['initiative_list'],
                            current_turn=game['current_turn'],
                            round_count=game['round_count'], 
                            notes=game['notes'],
                            code=code)

@app.route('/<code>/add', methods=['POST'])
def add(code):
    game = sessions.get(code)
    if not game:
        return "Session not found ):", 404
    name = request.form['name']
    initiative = int(request.form['initiative'])
    game['initiative_list'].append({'name': name, 'initiative': initiative, 'status': 'alive'})
    game['initiative_list'].sort(key=lambda x: x['initiative'], reverse=True)
    save_data()
    return redirect(url_for('admin_view',code=code))

@app.route('/<code>/add_note', methods=['POST'])
def add_note(code):
    game = sessions.get(code) 
    if not game:
        return "Session not found ):", 404
    note = request.form['note']
    game['notes'].append(note)
    save_data()
    return redirect(url_for('admin_view',code=code))

@app.route('/<code>/next', methods=['POST'])
def next_turn(code):
    game = sessions.get(code)
    if not game:
        return "session not found ):", 404
    game['current_turn'] = (game['current_turn'] + 1) % len(game['initiative_list'])
    if game['current_turn'] == 0:
        game['round_count'] += 1
    save_data()
    return redirect(url_for('admin_view', code=code))

@app.route('/<code>/dead/<name>', methods=['POST'])
def dead(code, name):
    game = sessions.get(code)
    if not game:
        return "session not found ):", 404
    for combatant in game['initiative_list']:
        if combatant['name'] == name:
            combatant['status'] = 'dead'
    save_data()
    return redirect(url_for('admin_view',code=code))


@app.route('/<code>/delete/<name>', methods=['POST'])
def delete(code, name):
    game = sessions.get(code)
    if not game:
        return "session not found ):", 404
    new_list = [d for d in game['initiative_list'] if d.get('name') != name]
    game['initiative_list'] = new_list
    save_data()
    return redirect(url_for('admin_view',code=code))


@app.route('/<code>/reset', methods=['POST'])
def reset(code):
    game = sessions.get(code)
    if not game:
        return "session not found ):", 404
    game['initiative_list'] = []
    game['notes'] = []
    game['current_turn'] = 0
    game['round_count'] = 1
    save_data()
    return redirect(url_for('admin_view',code=code))

@app.route('/<code>/clear_notes', methods=['POST'])
def clear_notes(code):
    global notes
    notes = []
    save_data()
    return redirect(url_for('admin_view',code=code))

@app.route('/<code>/upload_csv', methods=['POST'])
def upload_csv(code):
    if 'file' not in request.files:
        print("no file part in request")
        return redirect(url_for('admin_view',code=code))

    file = request.files['file']
    if file.filename == '':
        print('no selected file')
        return redirect(url_for('admin_view',code=code))
    if file and file.filename.endswith('.csv'):
        filepath = os.path.join('uploads', file.filename)
        file.save(filepath)
        print(f"uploaded csv file: {filepath}")
        import_csv(code, filepath)
        save_data()
    return redirect(url_for('admin_view',code=code))

if __name__ == '__main__':
    app.run(debug=True)
